# 基因组重测序分析与脚本使用教程（系统发育篇）

**脚本获取：** 本教程中使用的所有Python脚本均可从以下 GitHub 仓库获取：
https://github.com/Jhe1004/phylo-analysis-scripts/tree/main/22_re-sequencing/ReSeqPipline

欢迎使用本教程！本教程旨在帮助初学者理解什么是基因组重测序，并指导你如何使用这套特定的Python脚本，**通过重测序数据获取物种的基因组序列，以用于系统发育分析**。

## 1. 什么是基因组重测序？

**基因组重测序（Resequencing）** 是指对一个已知参考基因组序列的物种，测定一个个体或群体的基因组序列，并将其与参考基因组进行比对。

### 我们的目标：构建系统发育树

当你的研究目标是**系统发育分析**时，你需要的核心材料是来自**多个不同物种**的、可供比较的基因组序列。

### 我们的方法：GATK 标准流程

本套脚本采用 **GATK Best Practices** 标准流程，通过以下步骤获取高质量的一致性序列：

1.  **BWA MEM 比对**: 将测序数据比对到参考基因组
2.  **PCR 重复标记**: 使用 MarkDuplicates 消除 PCR 扩增偏差
3.  **GATK 变异检测**: 使用 HaplotypeCaller 进行精确的变异分型
4.  **VCF 转 FASTA**: 基于变异结果生成一致性序列，支持杂合位点的 IUPAC 代码

## 2. 分析流程概览

```
FASTQ → BWA比对 → MarkDuplicates → GATK变异检测 → VCF → FASTA → 合并矩阵
 (1)      (2)          (2)             (3)          (4)    (5,6)
```

| 步骤 | 脚本 | 描述 |
|:---:|:---|:---|
| 1 | `1_index_reference.py` | 为参考基因组创建 BWA、Samtools 和 GATK 索引 |
| 2 | `2_bwa_map.py` | 比对 + 排序 + PCR 重复标记 |
| 3 | `3_gatk_call.py` | GATK HaplotypeCaller 变异检测 |
| 4 | `4_vcf_to_fasta.py` | 从 VCF 生成一致性 FASTA（支持 IUPAC） |
| 5 | `5_check_non_atcg.py` | 检查序列质量（N 碱基比例） |
| 6 | `6_combine_fasta.py` | 合并所有样本为单一 MSA 矩阵 |

## 3. 所需软件

在开始之前，请确保安装以下软件：

```bash
# 使用 Conda 安装（推荐）
conda create -n reseq python=3.9 bwa samtools gatk4 -c bioconda -c conda-forge
conda activate reseq

# Python 依赖
pip install pysam biopython
```

**软件版本要求：**
- BWA >= 0.7.17
- Samtools >= 1.15
- GATK >= 4.2.0.0

## 4. 所需数据

1.  **参考基因组 (Reference Genome):**
    - 一个 FASTA 格式的近缘物种基因组文件
    - **注意: 不需要手动拼接 Scaffolds！** 本流程完全支持包含多个 Scaffolds/Contigs 的参考基因组

2.  **测序数据 (Raw Reads):**
    - 双端测序的 FASTQ 文件（如 `species1_R1.fastq.gz` 和 `species1_R2.fastq.gz`）

## 5. 详细步骤

### 步骤一：索引参考基因组

```bash
python 1_index_reference.py -r ref.fasta
```

**产出文件：**
- `ref.fasta.bwt`, `.amb`, `.ann`, `.pac`, `.sa` (BWA 索引)
- `ref.fasta.fai` (Samtools 索引)
- `ref.dict` (GATK 序列字典)

### 步骤二：序列比对与 PCR 去重

```bash
python 2_bwa_map.py \
    -r ref.fasta \
    -t 8 \
    -p _R1.fastq.gz \
    -m _R2.fastq.gz \
    -f ./fastq_files/ \
    -o ./bam_output/
```

**参数说明：**
- `-r`: 参考基因组
- `-t`: CPU 线程数
- `-p`: 正向读段 (R1) 后缀
- `-m`: 反向读段 (R2) 后缀
- `-f`: FASTQ 文件所在文件夹
- `-o`: BAM 输出文件夹
- `--use-gatk-markdup`: 使用 GATK MarkDuplicates（可选，更精确但更慢）

**产出文件：**
- `SampleA.bam` (标记了 PCR 重复的排序 BAM)
- `SampleA.bam.bai` 或 `.csi` (BAM 索引)

### 步骤三：GATK 变异检测

```bash
python 3_gatk_call.py \
    -r ref.fasta \
    -b ./bam_output/ \
    -o ./vcf_output/
```

**可选模式：**
- 默认模式：为每个样本生成 gVCF 文件
- `--single-vcf`: 生成普通 VCF（不含参考位点信息）
- `--joint-calling`: 进行多样本联合变异检测（推荐用于群体分析）

**产出文件：**
- `SampleA.g.vcf.gz` (gVCF 格式)
- 或 `all_samples.vcf.gz` (联合检测模式)

### 步骤四：从 VCF 生成一致性序列

```bash
python 4_vcf_to_fasta.py \
    -r ref.fasta \
    -v ./vcf_output/ \
    -o ./consensus_fasta_output/ \
    --min-gq 20 \
    --min-dp 3
```

**参数说明：**
- `--no-iupac`: 禁用 IUPAC 歧义代码（杂合位点将使用参考等位基因）
- `--min-gq`: 最小基因型质量阈值（默认 20）
- `--min-dp`: 最小覆盖深度阈值（默认 3）

**关于 IUPAC 代码：**

杂合位点会使用 IUPAC 歧义代码表示，例如：
- A/G → R
- C/T → Y
- A/C → M

这保留了杂合性信息，对于检测杂交、不完全谱系分选等信号非常重要。

**产出文件：**
- `SampleA_consensus.fasta` (包含所有 Scaffolds 的一致性序列)

### 步骤五：检查序列质量

```bash
cd consensus_fasta_output/
python ../5_check_non_atcg.py
```

**解读结果：**
- `Ratio (%)` 列显示非 ATCG 碱基（主要是 N）的比例
- 如果某样本的 N 比例 > 20%，说明测序深度不足，建议剔除

### 步骤六：合并所有序列

```bash
python ../6_combine_fasta.py
```

**产出文件：**
- `combined_sequences.fasta` - 包含所有样本的多序列比对矩阵

## 6. 常见问题

### Q: 为什么需要使用 GATK 而不是直接从 BAM 生成一致性序列？

**A:** GATK HaplotypeCaller 使用局部重组装算法，能够：
1. 更准确地检测 Indels
2. 精确区分杂合和纯合位点
3. 提供每个位点的质量分数（GQ/DP）用于过滤

### Q: 什么情况下应该使用 `--joint-calling` 模式？

**A:** 当你有多个样本（> 3个）且希望进行群体遗传学分析时，联合变异检测可以提高稀有变异的检测灵敏度。

### Q: 参考基因组有数万个 Scaffolds，会有问题吗？

**A:** 不会。本流程完全支持多 Scaffold 参考基因组。脚本会自动处理每个 Scaffold，并在最终合并时保持正确的顺序。

## 7. 后续分析

完成本流程后，你将获得 `combined_sequences.fasta` 文件。由于所有序列基于同一参考基因组，它们已经是对齐的多序列比对矩阵。

**下一步建议：**

1. **过滤高缺失位点：** 使用 [DelMissingSite](https://github.com/Jhe1004/DelMissingSite) 删除 N 比例过高的位点

2. **构建系统发育树：**
   ```bash
   # 使用 IQ-TREE
   iqtree -s trimmed_matrix.fasta -m MFP -bb 1000 -nt AUTO
   ```

祝你的系统发育分析顺利！